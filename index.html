<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>КЛТ — Рейтинг</title>
  <style>
    :root{
      --bg:#0b1020;
      --text:#eaf0ff;
      --muted:#a9b4d6;
      --accent:#7c5cff;
      --accent2:#21d4ff;
      --ok:#25c26e;
      --warn:#f6c343;
      --bad:#ff4d6d;
      --border:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r: 18px;
      --r2: 26px;
      --max: 1120px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 25% -10%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 500px at 85% 0%, rgba(33,212,255,.22), transparent 55%),
        linear-gradient(180deg, #070a14 0%, var(--bg) 40%, #070a14 100%);
      min-height:100vh;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:24px}
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(7,10,20,.65);
      border-bottom: 1px solid var(--border);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      max-width:var(--max); margin:0 auto; padding:14px 24px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 25px rgba(124,92,255,.25);
    }
    .menu{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pill{
      padding:10px 12px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted);
      background: rgba(255,255,255,.03);
      font-weight:800; font-size:14px;
      transition: .15s ease;
    }
    .pill:hover{transform: translateY(-1px); color:var(--text); border-color: rgba(255,255,255,.18)}
    .pill.active{
      color:var(--text);
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.14);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px; padding:12px 16px;
      border-radius: 14px;
      border:1px solid rgba(124,92,255,.65);
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(33,212,255,.55));
      color:#0a0f1f;
      font-weight:1000;
      box-shadow: 0 14px 35px rgba(124,92,255,.25);
      transition:.15s ease;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-color: rgba(255,255,255,.16);
      box-shadow:none;
      font-weight:900;
    }

    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
    }
    .crumbs{color:var(--muted); font-weight:900; font-size:12px; text-transform:uppercase; letter-spacing:.22px}
    .pageTitle{margin:6px 0 8px; font-size:28px; letter-spacing:-.4px}

    input[type="text"]{
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(8,12,24,.55);
      color: var(--text);
      font-weight:1000;
      letter-spacing:.6px;
      outline:none;
      min-width: 240px;
    }
    input[type="text"]::placeholder{color: rgba(169,180,214,.65); letter-spacing:.2px}
    .formRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .notice{
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;
      line-height:1.5;
      margin-top:12px;
    }
    .notice.ok{border-color: rgba(37,194,110,.35)}
    .notice.bad{border-color: rgba(255,77,109,.35)}
    .notice.expelled{
      border-color: rgba(255,77,109,.75);
      background: rgba(255,77,109,.12);
      color: rgba(255,220,226,.98);
    }

    .small{font-size:12px; color:var(--muted); font-weight:800}
    .muted{color:var(--muted)}
    .divider{height:1px; background: var(--border); margin:14px 0}

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .kpi{
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .kpi .k{color:var(--muted); font-weight:900; font-size:12px}
    .kpi .v{font-weight:1100; font-size:18px; margin-top:6px}
    .kpi .c{color:var(--muted); font-weight:800; font-size:12px; margin-top:6px}

    .dash{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:12px;
    }

    .chartRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap:12px;
      margin-top:12px;
      align-items:stretch;
    }

    .chartCard{
      padding:14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .chartTitle{font-weight:1000; margin:0 0 10px}
    canvas{width:100%; height:260px; display:block}
    #top3Chart{height:240px;}

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top:12px;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size: 13px;
      vertical-align: top;
    }
    .table th{color: var(--muted); font-weight:1000; letter-spacing:.2px}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-weight:1000;
      font-size:12px;
      white-space: nowrap;
    }
    .b-ok{border-color: rgba(37,194,110,.35)}
    .b-warn{border-color: rgba(246,195,67,.35)}
    .b-bad{border-color: rgba(255,77,109,.35)}

    .wip{padding:28px; text-align:center;}
    .wip .icon{font-size:38px; margin-bottom:10px}
    .wip .title{font-weight:1100; font-size:22px}
    .wip .desc{color:var(--muted); margin-top:6px; font-weight:800}

    .supportWrap{
      margin-top:14px;
      padding:14px 0 8px;
      border-top: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .supportLink{
      color: rgba(234,240,255,.92);
      font-weight:1000;
      border-bottom: 1px dashed rgba(255,255,255,.28);
      cursor:pointer;
      user-select:none;
    }
    .supportBox{
      display:none;
      margin-top:10px;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight:800;
      line-height:1.6;
    }
    .supportBox a{
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    @media (max-width: 980px){
      .kpiGrid{grid-template-columns: 1fr 1fr}
      .dash{grid-template-columns: 1fr}
      .chartRow{grid-template-columns: 1fr; grid-template-rows: auto;}
    }
    @media (max-width: 520px){
      .menu{display:none}
      .kpiGrid{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="nav">
      <a class="brand" href="#/">
        <div class="logo" aria-hidden="true"></div>
        <div>КЛТ<span class="muted">.demo</span></div>
      </a>

      <div class="menu" role="navigation" aria-label="Навигация">
        <a class="pill" data-link href="#/">Главная</a>
        <a class="pill" data-link href="#/about">О КЛТ</a>
        <a class="pill" data-link href="#/tournaments">Турниры</a>
        <a class="pill" data-link href="#/kb">База знаний</a>
        <a class="pill" href="https://disk.yandex.ru/d/p1wxZn33wEVVyw" target="_blank" rel="noreferrer">Распределение</a>
        <a class="pill" data-link href="#/rating">Рейтинг</a>
      </div>

      <a class="btn" href="#/rating" aria-label="Показать результаты">Показать результаты</a>
    </div>
  </div>

  <main class="wrap" id="app" aria-live="polite"></main>

  <script>
    // ---------------------------
    // Base URLs (robust with hash routing)
    // ---------------------------
    function baseNoHash(){
      const u = new URL(location.href);
      u.hash = "";
      u.search = "";
      return u.toString();
    }
    const DATA_URLS = {
      students: new URL("./site_students.csv", baseNoHash()).toString(),
      sessions: new URL("./site_sessions.csv", baseNoHash()).toString(),
    };

    const DB = {
      loaded: false,
      loading: false,
      loadError: "",
      studentsById: new Map(),
      sessionsById: new Map(),
      totalsById: new Map(),
      leagueById: new Map(),
      thresholds: { goldN:0, silverN:0, totalN:0 },
    };

    // ---------------------------
    // Helpers
    // ---------------------------
    const app = document.getElementById("app");
    const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    const html = (strings, ...vals)=> strings.map((s,i)=> s + (vals[i] ?? "")).join("");
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    const normalizeId = (v) => {
      const raw = String(v ?? "").trim().replace(/\D/g,"");
      if (!raw) return "";
      return raw.padStart(4,"0").slice(-4);
    };

    // ✅ updated: strict parsing, rejects 1900-01-00 and any day/month 00
    function parseISODateMaybe(s){
      const t = String(s ?? "").trim();
      if (!t) return null;

      const mISO = t.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (mISO){
        const yy = Number(mISO[1]);
        const mm = Number(mISO[2]);
        const dd = Number(mISO[3]);

        if (!Number.isFinite(yy) || !Number.isFinite(mm) || !Number.isFinite(dd)) return null;
        if (mm < 1 || mm > 12) return null;
        if (dd < 1 || dd > 31) return null;

        const d = new Date(yy, mm - 1, dd);
        if (isNaN(+d)) return null;
        if (d.getFullYear() !== yy || (d.getMonth()+1) !== mm || d.getDate() !== dd) return null;

        return d;
      }

      if (/^\d{2}\.\d{2}\.\d{4}$/.test(t)) {
        const [ddS, mmS, yyS] = t.split(".");
        const dd = Number(ddS), mm = Number(mmS), yy = Number(yyS);
        if (mm < 1 || mm > 12) return null;
        if (dd < 1 || dd > 31) return null;
        const d = new Date(yy, mm-1, dd);
        if (isNaN(+d)) return null;
        if (d.getFullYear() !== yy || (d.getMonth()+1) !== mm || d.getDate() !== dd) return null;
        return d;
      }

      const d = new Date(t);
      return isNaN(+d) ? null : d;
    }

    // ✅ updated: invalid -> "—"
    function formatDateRU(s){
      const raw = String(s ?? "").trim();
      const d = parseISODateMaybe(raw);
      if (!d) return "—";
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = String(d.getFullYear());
      return `${dd}.${mm}.${yy}`;
    }

    function includesAny(hay, needles){
      const s = String(hay ?? "").toLowerCase();
      return needles.some(n => s.includes(String(n).toLowerCase()));
    }

    function detectDelimiter(firstLine){
      let comma = 0, semi = 0, tab = 0;
      let inQuotes = false;
      for (let i=0;i<firstLine.length;i++){
        const ch = firstLine[i];
        const next = firstLine[i+1];
        if (ch === '"' && inQuotes && next === '"'){ i++; continue; }
        if (ch === '"'){ inQuotes = !inQuotes; continue; }
        if (!inQuotes){
          if (ch === ",") comma++;
          else if (ch === ";") semi++;
          else if (ch === "\t") tab++;
        }
      }
      if (tab >= semi && tab >= comma) return "\t";
      if (semi >= comma) return ";";
      return ",";
    }

    function parseCSV(text){
      const clean = String(text ?? "").replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      const firstNonEmpty = clean.split("\n").find(l=>l.trim().length) || "";
      const delim = detectDelimiter(firstNonEmpty);

      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i=0;i<clean.length;i++){
        const ch = clean[i];
        const next = clean[i+1];

        if (ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQuotes = !inQuotes; continue; }

        if (!inQuotes && ch === "\n"){
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }

        if (!inQuotes && ch === delim){
          row.push(cur);
          cur = "";
          continue;
        }

        cur += ch;
      }
      if (cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }
      return rows.filter(r=> r.some(x=> String(x).trim().length));
    }

    const normalizeHeader = (h) =>
      String(h ?? "").replace(/^\uFEFF/, "").trim().toLowerCase();

    const findHeader = (arr, variants) => {
      const set = variants.map(v=> String(v).toLowerCase());
      return arr.findIndex(x=> set.includes(x));
    };

    function toNumberMaybe(v){
      const s = String(v ?? "").trim();
      if (!s) return null;
      const n = Number(s.replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }

    function isAttendanceValue(v){
      const s = String(v ?? "").trim();
      if (!s) return false;
      if (s === "С" || s === "c" || s === "C") return true;
      const n = toNumberMaybe(s);
      return n === 0 || n === -1 || n === 1;
    }

    function attendanceIsPresent(v){
      const s = String(v ?? "").trim();
      if (!s) return null;
      if (s === "С" || s === "c" || s === "C") return true;
      const n = toNumberMaybe(s);
      if (n === -1) return false;
      if (n === 0 || n === 1) return true;
      return null;
    }

    // ✅ strict eligibility: points only if score_or_attendance === "0"
    function eligibleForScoring(row){
      const a = String(row.score_or_attendance ?? "").trim();
      if (a !== "0") return false;

      const pr = String(row.place_or_result ?? "").trim();
      if (!pr) return true;
      if (pr === "#Н/Д" || pr === "#N/A" || pr.toLowerCase().includes("н/д")) return false;
      return true;
    }

    function normTournamentKey(name){
      const s = String(name ?? "").toLowerCase();
      if (s.includes("business") || s.includes("cats") || s.includes("бизнес")) return "Business Cats";
      if (s.includes("пейнтбол") || s.includes("paint")) return "Пейнтбол";
      if (s.includes("civilization") || s.includes("civ")){
        if (s.includes("duel") || s.includes("дуel") || s.includes("дуэль")) return "Civilization: DUEL";
        if (s.includes("ceo")) return "Civilization: CEO";
        return "Civilization: Solo";
      }
      if (s.includes("бенди") || s.includes("bandy")) return "Бенди";
      if (s.includes("feudal")) return "Life is Feudal";
      return (name || "—").trim() || "—";
    }

    function parsePlaceNumber(s){
      const txt = String(s ?? "").trim();
      if (!txt) return null;
      if (txt === "#Н/Д" || txt === "#N/A" || txt.toLowerCase().includes("н/д")) return null;
      const m = txt.match(/(\d{1,3})/);
      if (!m) return null;
      const n = Number(m[1]);
      return Number.isFinite(n) ? n : null;
    }

    function bcPointsFromPlace(place){
      const p = clamp(place, 1, 20);
      const score = Math.round(((20 - p) / 19) * 100);
      return clamp(score, 0, 100);
    }

    function parseYearFromRow(row){
      const s = [
        row.place_or_result,
        row.score_or_attendance,
        row.comment,
        row.extra,
        row.label,
        row.stage
      ].map(x=>String(x ?? "")).join(" ");
      const m = s.match(/(16\d{2}|17\d{2}|18\d{2})/);
      if (!m) return null;
      const y = Number(m[1]);
      return Number.isFinite(y) ? y : null;
    }

    function playoffRoundPoints(denom){
      const map = { 32:20, 16:30, 8:40, 4:60, 2:80 };
      return map[denom] ?? null;
    }
    function extractPlayoffDenom(text){
      const blob = String(text ?? "").toLowerCase();
      const m = blob.match(/1\s*[/\\]\s*(32|16|8|4|2)/);
      if (!m) return null;
      const denom = Number(m[1]);
      return Number.isFinite(denom) ? denom : null;
    }

    function civYearPointsFromYear(year){
      const best = 1652;
      const worst = 1800;
      const y = clamp(year, best, worst);
      const score = 100 - ((y - best) / (worst - best)) * 100;
      return clamp(Math.round(score), 0, 100);
    }

    function revolutionIsWin(row){
      const s = [
        row.place_or_result,
        row.score_or_attendance,
        row.comment,
        row.extra,
        row.label,
        row.stage
      ].map(x=>String(x ?? "")).join(" ").toLowerCase();

      if (includesAny(s, ["побед", "win", "лучший", "защит"])) return true;
      if (includesAny(s, ["проиг", "loss", "не защит", "выбыл"])) return false;
      return false;
    }

    // ---------------------------
    // Scoring (STRICT)
    // ---------------------------
    function scoreSession(row){
      const t = normTournamentKey(row.tournament);
      const stage = String(row.stage || row.label || "").toLowerCase();
      const placeText = String(row.place_or_result || "").trim();
      const valText = String(row.score_or_attendance || "").trim();
      const comment = String(row.comment || row.extra || row.label || "").trim();
      const blobAll = (stage + " " + placeText + " " + valText + " " + comment).toLowerCase();

      if (!eligibleForScoring(row)){
        return { points: null, explain: "Не начисляем: нет подтверждения участия (нужно 0 в посещаемости)" };
      }

      if (includesAny(stage, ["трен", "training"])) {
        return { points: null, explain: "Тренировочная — не в зачёт" };
      }

      if (t === "Business Cats"){
        if (!includesAny(stage, ["рейтинг", "рейтин", "rating"])) return { points: null, explain: "Не рейтинговая — не в зачёт" };

        const pRaw = String(placeText || "").trim();
        if (pRaw === "#Н/Д" || pRaw === "#N/A" || pRaw.toLowerCase().includes("н/д")){
          return { points: null, explain: "Нет места (#Н/Д) — не начисляем" };
        }

        const p = parsePlaceNumber(placeText) ?? parsePlaceNumber(comment);
        if (p === null) return { points: null, explain: "Нет места — баллы не посчитаны" };
        const pts = bcPointsFromPlace(p);
        return { points: pts, explain: `Business Cats: место ${p} → ${pts} баллов` };
      }

      if (t === "Пейнтбол"){
        if (includesAny(stage, ["групп", "group"])){
          const win = includesAny(blobAll, ["побед", "win"]);
          const lose = includesAny(blobAll, ["проиг", "loss", "пораж", "выбыл"]);
          if (win) return { points: 100, explain: "Пейнтбол (группа): Победа → 100" };
          if (lose) return { points: 0, explain: "Пейнтбол (группа): Поражение/выбыл → 0" };
          return { points: null, explain: "Пейнтбол (группа): нет результата" };
        }

        if (includesAny(blobAll, ["плей", "playoff", "1/", "1\\", "финал", "final", "1/32", "1/16", "1/8", "1/4", "1/2"])){
          const lose = includesAny(blobAll, ["выбыл", "проиг", "loss", "пораж"]);
          if (lose) return { points: 0, explain: "Пейнтбол (плей-офф): выбыл/проигрыш → 0" };

          const win = includesAny(blobAll, ["побед", "win"]);
          if (win) return { points: 100, explain: "Пейнтбол (плей-офф): Победа → 100" };

          const denom = extractPlayoffDenom(blobAll);
          if (denom){
            const pts = playoffRoundPoints(denom);
            if (pts !== null) return { points: pts, explain: `Пейнтбол (плей-офф): 1/${denom} → ${pts}` };
          }

          return { points: 0, explain: "Пейнтбол (плей-офф): выбыл/не распознан → 0" };
        }

        return { points: null, explain: "Пейнтбол: не зачётный этап" };
      }

      if (t === "Civilization: Solo" || t === "Civilization: DUEL"){
        if (!includesAny(stage, ["революц", "revolution"])) return { points: null, explain: "Civ: не революция — не в зачёт" };

        const y = parseYearFromRow(row);
        const yearPts = y ? civYearPointsFromYear(y) : null;

        const win = revolutionIsWin(row);
        const winPts = win ? 100 : 0;

        if (yearPts === null){
          if (win) return { points: 100, explain: "Civ: победа в революции → 100 (год не найден)" };
          return { points: null, explain: "Civ: нет года революции — баллы не посчитаны" };
        }

        const total = winPts + yearPts;
        const winText = win ? "+ победа 100" : "+ победа 0";
        return { points: total, explain: `Civ: год ${y} → ${yearPts} ${winText} = ${total}` };
      }

      return { points: null, explain: "Пока не начисляем (добавим позже)" };
    }

    function computeScoredSessions(id){
      const sessions = DB.sessionsById.get(id) || [];
      const out = [];
      for (const s of sessions){
        const scored = scoreSession(s);
        if (typeof scored.points === "number" && Number.isFinite(scored.points)){
          out.push({
            ...s,
            tournamentKey: normTournamentKey(s.tournament),
            points: scored.points,
            explain: scored.explain
          });
        }
      }
      out.sort((a,b)=> (a.date || "").localeCompare(b.date || ""));
      return out;
    }

    function computeStudentTotalPoints(id){
      const scored = computeScoredSessions(id);
      return scored.reduce((sum, x)=> sum + (x.points || 0), 0);
    }

    // ✅ UPDATED: exclude expelled from leagues & totals
    function recomputeLeagues(){
      // считаем только обучающихся
      const ids = Array.from(DB.studentsById.keys()).filter(id=>{
        const st = String(DB.studentsById.get(id)?.status || "").trim();
        return st !== "В списках отчисленных";
      });

      const totals = ids.map(id => ({ id, total: computeStudentTotalPoints(id) }));
      totals.sort((a,b)=> b.total - a.total);

      const totalN = totals.length || 1;
      const goldN = Math.max(1, Math.ceil(totalN * 0.05));
      const silverN = Math.max(goldN, Math.ceil(totalN * 0.20));

      DB.totalsById.clear();
      DB.leagueById.clear();

      totals.forEach((x, idx)=>{
        DB.totalsById.set(x.id, x.total);
        let league = "Бронзовая";
        if (idx < goldN) league = "Золотая";
        else if (idx < silverN) league = "Серебряная";
        DB.leagueById.set(x.id, league);
      });

      DB.thresholds = { goldN, silverN, totalN };
    }

    function leagueBadge(league){
      if (league === "Золотая") return { label:"Золотая", cls:"b-ok" };
      if (league === "Серебряная") return { label:"Серебряная", cls:"b-warn" };
      return { label:"Бронзовая", cls:"b-bad" };
    }

    // ---------------------------
    // Recommendations + Strong side
    // ---------------------------
    function calcTrackers(student, sessions, scored){
      const attSessions = sessions.filter(s=> isAttendanceValue(s.score_or_attendance));
      const presentCount = attSessions.reduce((acc, s)=> acc + (attendanceIsPresent(s.score_or_attendance) === true ? 1 : 0), 0);
      const attTotal = attSessions.length || 0;
      const absences = Math.max(0, attTotal - presentCount);
      const attPercent = attTotal ? Math.round(presentCount / attTotal * 100) : 0;

      const pts = scored.map(s=>s.points||0).sort((a,b)=>a-b);
      const typical = pts.length ? pts[Math.floor(pts.length/2)] : 0;

      const last = scored.slice(-6);
      const recentAvg = last.length ? Math.round(last.reduce((a,x)=>a+(x.points||0),0)/last.length) : 0;

      return { attPercent, absences, typical, recentAvg };
    }

    function buildAdvice(track){
      const advice = [];

      if (track.absences >= 4){
        advice.push({
          title: "Дисциплина посещений",
          text: `У вас ${track.absences} прогул(а/ов) — это зона риска. Верните ритм: регулярное участие быстро поднимает и уверенность, и результат.`,
          tag: "Риск",
          cls: "b-warn"
        });
      } else if (track.attPercent < 85){
        advice.push({
          title: "Дисциплина посещений",
          text: `Посещаемость ${track.attPercent}%. Чуть больше регулярности — и прогресс станет заметнее уже в ближайших зачётных активностях.`,
          tag: "Фокус",
          cls: "b-warn"
        });
      } else {
        advice.push({
          title: "Дисциплина посещений",
          text: `Отлично: посещаемость ${track.attPercent}%. Такой ритм — сильное преимущество. Продолжайте в том же духе.`,
          tag: "ОК",
          cls: "b-ok"
        });
      }

      const t = track.typical || 0;
      let levelText = "";
      let tag = "Старт";
      let cls = "b-warn";

      if (t >= 90){
        levelText = `Высокий уровень: ваш типичный результат — ${t}. Это уже уровень лидеров. Сохраняйте темп и смело усложняйте задачи — так растёт максимум.`;
        tag = "Лидеры"; cls = "b-ok";
      } else if (t >= 75){
        levelText = `Крепкий уровень: ваш типичный результат — ${t}. Отличная основа для рывка. Немного системности — и результаты станут стабильнее и выше.`;
        tag = "Крепко"; cls = "b-ok";
      } else if (t >= 55){
        levelText = `Хорошая точка роста: ваш типичный результат — ${t}. Сейчас лучше всего работает фокус на одном-двух навыках и повторение сильных решений.`;
        tag = "Рост"; cls = "b-warn";
      } else {
        levelText = `Стартовый уровень: ваш типичный результат — ${t}. Это нормальная точка начала. Самое важное сейчас — регулярность и уверенный, понятный план действий.`;
        tag = "Старт"; cls = "b-warn";
      }

      advice.push({ title: "Стабильность результата", text: levelText, tag, cls });

      let focus = "аналитики";
      if (track.absences >= 4) focus = "дисциплины";
      else if (t < 60) focus = "коммуникации";
      else if (t < 75) focus = "аналитики и планирования";
      else focus = "тактики и принятия решений";

      advice.push({
        title: "План на следующую неделю",
        text: `Ваш текущий темп — в среднем ${track.recentAvg} баллов. Выберите один фокус: ${focus}. Сделайте его вашей сильной привычкой недели — фиксируйте лучшие решения и повторяйте их. Так результат будет расти устойчиво и предсказуемо.`,
        tag: "План",
        cls: "b-ok"
      });

      return advice;
    }

    function computeStrongSide(scored){
      const byT = new Map();
      for (const s of (scored || [])){
        const k = s.tournamentKey || normTournamentKey(s.tournament);
        if (!byT.has(k)) byT.set(k, []);
        byT.get(k).push(s.points || 0);
      }

      const stats = Array.from(byT.entries()).map(([k, arr])=>{
        const sum = arr.reduce((a,x)=>a+x,0);
        const avg = arr.length ? sum/arr.length : 0;
        const peak = arr.length ? Math.max(...arr) : 0;
        return { k, avg, peak, n: arr.length };
      }).sort((a,b)=> (b.avg - a.avg) || (b.peak - a.peak));

      if (!stats.length){
        return { text: "Пока нет зачётных результатов. Как только появятся — мы покажем вашу сильную сторону и точку роста.", badge:{text:"—", cls:"b-warn"} };
      }

      const top = stats[0];
      let badge = { text:"Сильная", cls:"b-ok" };
      if (top.avg < 60) badge = { text:"В рост", cls:"b-warn" };

      const text = (top.avg >= 75)
        ? `Лучше всего у вас получается этап «${top.k}». Продолжайте опираться на это — и переносите подход в другие этапы.`
        : `Сейчас лучший фокус для роста — этап «${top.k}». Стабильный план и регулярная практика помогут поднять результат.`;

      return { text, badge };
    }

    // ---------------------------
    // Charts
    // ---------------------------
    function setupCanvas(id){
      const c = document.getElementById(id);
      if (!c) return null;
      const ctx = c.getContext("2d");
      const dpr = window.devicePixelRatio || 1;
      const rect = c.getBoundingClientRect();
      const w = Math.floor(rect.width * dpr);
      const h = Math.floor(rect.height * dpr);
      if (c.width !== w || c.height !== h){
        c.width = w; c.height = h;
      }
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);
      return { c, ctx, w: rect.width, h: rect.height };
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function drawDonut(id, present, absent){
      const pack = setupCanvas(id);
      if (!pack) return;
      const {ctx, w, h} = pack;
      ctx.clearRect(0,0,w,h);

      const cx = w/2, cy = h/2;
      const r = Math.min(w,h) * 0.32;
      const thick = Math.max(14, r*0.35);

      const total = Math.max(1, present + absent);
      const p = present / total;

      ctx.lineCap = "round";
      ctx.lineWidth = thick;

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();

      const start = -Math.PI/2;
      const end = start + Math.PI*2*p;
      const g = ctx.createLinearGradient(cx-r, cy, cx+r, cy);
      g.addColorStop(0, "rgba(124,92,255,.95)");
      g.addColorStop(1, "rgba(33,212,255,.55)");
      ctx.strokeStyle = g;

      ctx.beginPath();
      ctx.arc(cx, cy, r, start, end);
      ctx.stroke();

      ctx.fillStyle = "rgba(234,240,255,.95)";
      ctx.font = "900 28px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText(Math.round(p*100) + "%", cx, cy + 6);

      ctx.fillStyle = "rgba(169,180,214,.85)";
      ctx.font = "900 12px ui-sans-serif, system-ui";
      ctx.fillText("посещаемость", cx, cy + 28);
    }

    function drawProgressDots(id, scored){
      const pack = setupCanvas(id);
      if (!pack) return;
      const {ctx, w, h, c} = pack;
      ctx.clearRect(0,0,w,h);

      const padL = 44, padR = 16, padT = 16, padB = 28;
      const left = padL, right = w - padR;
      const top = padT, bottom = h - padB;

      const points = (scored || []).slice(-80);
      const n = Math.max(1, points.length);
      const xs = points.map((_,i)=> left + (i*(right-left)/Math.max(1,n-1)));

      const maxV = Math.max(100, ...points.map(p=>p.points||0), 1);
      const minV = 0;

      const ys = points.map(p=>{
        const v = clamp(p.points||0, minV, maxV);
        return bottom - ((v-minV)/(maxV-minV))*(bottom-top);
      });

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      ctx.fillStyle = "rgba(169,180,214,.85)";
      ctx.font = "900 12px ui-sans-serif, system-ui";
      ctx.textAlign = "right";

      const ticks = 4;
      for (let i=0;i<=ticks;i++){
        const tt = i/ticks;
        const y = top + tt*(bottom-top);
        const val = Math.round((1-tt)*maxV);
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);
        ctx.stroke();
        ctx.fillText(String(val), left-8, y+4);
      }

      if (points.length >= 2){
        ctx.beginPath();
        ctx.moveTo(xs[0], ys[0]);
        for (let i=1;i<points.length;i++) ctx.lineTo(xs[i], ys[i]);
        ctx.lineTo(xs[points.length-1], bottom);
        ctx.lineTo(xs[0], bottom);
        ctx.closePath();
        const g = ctx.createLinearGradient(0, top, 0, bottom);
        g.addColorStop(0, "rgba(124,92,255,.22)");
        g.addColorStop(1, "rgba(33,212,255,.06)");
        ctx.fillStyle = g;
        ctx.fill();
      }

      if (points.length >= 2){
        ctx.beginPath();
        ctx.moveTo(xs[0], ys[0]);
        for (let i=1;i<points.length;i++) ctx.lineTo(xs[i], ys[i]);
        ctx.strokeStyle = "rgba(234,240,255,.85)";
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      c.__dots = [];
      for (let i=0;i<points.length;i++){
        const x = xs[i], y = ys[i];
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI*2);
        ctx.fillStyle = "rgba(33,212,255,.75)";
        ctx.fill();
        c.__dots.push({ x, y, r: 9, data: points[i] });
      }

      ctx.fillStyle = "rgba(169,180,214,.85)";
      ctx.font = "900 12px ui-sans-serif, system-ui";
      ctx.textAlign = "left";
      ctx.fillText("сессии (последние)", left, h - 8);
    }

    function drawActivityByDate(id, scored){
      const pack = setupCanvas(id);
      if (!pack) return;
      const {ctx, w, h, c} = pack;
      ctx.clearRect(0,0,w,h);

      const padL = 44, padR = 16, padT = 16, padB = 30;
      const left = padL, right = w - padR;
      const top = padT, bottom = h - padB;

      const m = new Map();
      for (const s of (scored || [])){
        const key = formatDateRU(s.date || "");
        if (key === "—") continue;
        m.set(key, (m.get(key)||0) + (s.points||0));
      }
      const items = Array.from(m.entries())
        .map(([date, pts])=>({ date, pts }))
        .sort((a,b)=>{
          const da = parseISODateMaybe(a.date) || new Date(0);
          const db = parseISODateMaybe(b.date) || new Date(0);
          return +da - +db;
        });

      const data = items.slice(-28);
      const n = Math.max(1, data.length);
      const maxV = Math.max(100, ...data.map(x=>x.pts), 1);

      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      ctx.fillStyle = "rgba(169,180,214,.85)";
      ctx.font = "900 12px ui-sans-serif, system-ui";
      ctx.textAlign = "right";

      const ticks = 4;
      for (let i=0;i<=ticks;i++){
        const tt = i/ticks;
        const y = top + tt*(bottom-top);
        const val = Math.round((1-tt)*maxV);
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);
        ctx.stroke();
        ctx.fillText(String(val), left-8, y+4);
      }

      const gap = 10;
      const barW = Math.max(10, (right-left - gap*(n-1))/n);

      c.__bars = [];

      for (let i=0;i<data.length;i++){
        const x = left + i*(barW+gap);
        const v = data[i].pts;
        const bh = (v/maxV) * (bottom-top-8);
        const y = bottom - bh;

        const g = ctx.createLinearGradient(x, y, x, bottom);
        g.addColorStop(0, "rgba(124,92,255,.95)");
        g.addColorStop(1, "rgba(33,212,255,.55)");
        ctx.fillStyle = g;

        roundRect(ctx, x, y, barW, bh, 10);
        ctx.fill();

        ctx.fillStyle = "rgba(169,180,214,.85)";
        ctx.font = "12px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        const dLabel = data[i].date.slice(0,5);
        ctx.fillText(dLabel, x+barW/2, bottom+16);

        c.__bars.push({ x, y, w: barW, h: bh, date: data[i].date, value: v });
      }
    }

    function drawTop3(id, scored){
      const pack = setupCanvas(id);
      if (!pack) return;
      const {ctx, w, h, c} = pack;
      ctx.clearRect(0,0,w,h);

      const best = (scored || [])
        .slice()
        .sort((a,b)=> (b.points||0) - (a.points||0))
        .slice(0,3);

      const padL = 16, padR = 16, padT = 16, padB = 16;
      const left = padL, right = w - padR;
      const top = padT, bottom = h - padB;

      const rowH = (bottom - top) / 3;
      const maxV = Math.max(1, ...best.map(x=>x.points||0), 100);

      c.__bars = [];

      ctx.globalAlpha = 0.5;
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      for (let i=0;i<3;i++){
        const y = top + i*rowH;
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(right, y);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      for (let i=0;i<3;i++){
        const y0 = top + i*rowH + 10;
        const barH = Math.max(18, rowH - 20);

        const item = best[i];
        if (!item){
          ctx.fillStyle = "rgba(169,180,214,.75)";
          ctx.font = "900 13px ui-sans-serif, system-ui";
          ctx.textAlign = "left";
          ctx.fillText("—", left, y0 + barH/2 + 5);
          continue;
        }

        const v = item.points || 0;
        const barW = (right - left) * (v / maxV);

        const g = ctx.createLinearGradient(left, y0, left + barW, y0);
        g.addColorStop(0, "rgba(124,92,255,.95)");
        g.addColorStop(1, "rgba(33,212,255,.55)");
        ctx.fillStyle = g;

        roundRect(ctx, left, y0, Math.max(10, barW), barH, 12);
        ctx.fill();

        const title = `${item.tournamentKey || normTournamentKey(item.tournament)} • ${formatDateRU(item.date || "—")}`;
        const sub = `${item.stage || item.label || "—"} • ${item.place_or_result || item.score_or_attendance || "—"}`;

        ctx.fillStyle = "rgba(234,240,255,.95)";
        ctx.font = "1000 13px ui-sans-serif, system-ui";
        ctx.textAlign = "left";
        ctx.fillText(title, left + 12, y0 + 18);

        ctx.fillStyle = "rgba(169,180,214,.85)";
        ctx.font = "900 12px ui-sans-serif, system-ui";
        ctx.fillText(sub, left + 12, y0 + 36);

        ctx.fillStyle = "rgba(234,240,255,.95)";
        ctx.font = "1100 14px ui-sans-serif, system-ui";
        ctx.textAlign = "right";
        ctx.fillText(`${v} баллов`, right, y0 + 22);

        c.__bars.push({
          x:left, y:y0, w:Math.max(10, barW), h:barH,
          title, sub, value:v
        });
      }
    }

    function ensureTooltip(){
      let tip = document.getElementById("tip");
      if (!tip){
        tip = document.createElement("div");
        tip.id = "tip";
        tip.style.position = "fixed";
        tip.style.zIndex = 9999;
        tip.style.pointerEvents = "none";
        tip.style.padding = "8px 10px";
        tip.style.borderRadius = "12px";
        tip.style.border = "1px solid rgba(255,255,255,.16)";
        tip.style.background = "rgba(7,10,20,.88)";
        tip.style.color = "rgba(234,240,255,.95)";
        tip.style.font = "12px ui-sans-serif, system-ui";
        tip.style.fontWeight = "900";
        tip.style.display = "none";
        tip.style.maxWidth = "360px";
        document.body.appendChild(tip);
      }
      return tip;
    }

    function attachDotTooltip(canvasId){
      const c = document.getElementById(canvasId);
      if (!c) return;
      const tip = ensureTooltip();

      function getPos(e){
        const r = c.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }

      c.addEventListener("mousemove", (e)=>{
        const dots = c.__dots || [];
        const p = getPos(e);
        const hit = dots.find(d=>{
          const dx = p.x - d.x, dy = p.y - d.y;
          return (dx*dx + dy*dy) <= (d.r*d.r);
        });
        if (!hit){
          tip.style.display = "none";
          return;
        }
        const s = hit.data;
        const title = `${s.tournamentKey || normTournamentKey(s.tournament)} • ${formatDateRU(s.date || "—")}`;
        const stage = (s.stage || s.label || "—");
        const res = (s.place_or_result || s.score_or_attendance || "—");
        tip.innerHTML = `${esc(title)}<br><span style="color:rgba(169,180,214,.9)">${esc(stage)} • ${esc(res)}</span><br><b>${esc(s.points)} баллов</b>`;
        tip.style.display = "block";
        tip.style.left = (e.clientX + 12) + "px";
        tip.style.top = (e.clientY + 12) + "px";
      });

      c.addEventListener("mouseleave", ()=> tip.style.display = "none");
    }

    function attachBarTooltip(canvasId){
      const c = document.getElementById(canvasId);
      if (!c) return;
      const tip = ensureTooltip();

      function getPos(e){
        const r = c.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }

      c.addEventListener("mousemove", (e)=>{
        const bars = c.__bars || [];
        const p = getPos(e);
        const hit = bars.find(b=> p.x >= b.x && p.x <= b.x+b.w && p.y >= b.y && p.y <= b.y+b.h);
        if (!hit){
          tip.style.display = "none";
          return;
        }

        if (hit.date){
          tip.textContent = `${hit.date}: ${hit.value} баллов`;
        } else {
          tip.innerHTML = `${esc(hit.title)}<br><span style="color:rgba(169,180,214,.9)">${esc(hit.sub)}</span><br><b>${esc(hit.value)} баллов</b>`;
        }

        tip.style.display = "block";
        tip.style.left = (e.clientX + 12) + "px";
        tip.style.top = (e.clientY + 12) + "px";
      });

      c.addEventListener("mouseleave", ()=> tip.style.display = "none");
    }

    // ---------------------------
    // Robust fetch + Ensure load
    // ---------------------------
    async function fetchTextOrThrow(url, label){
      let res;
      try{
        res = await fetch(url, { cache:"no-store" });
      }catch(e){
        throw new Error(`${label}: сеть/доступ заблокирован (${String(e?.message || e)})`);
      }
      if (!res.ok){
        throw new Error(`${label}: HTTP ${res.status} ${res.statusText}`);
      }
      const txt = await res.text();
      if (!String(txt).trim()){
        throw new Error(`${label}: файл пустой`);
      }
      return txt;
    }

    async function ensureDBLoaded(force=false){
      if (DB.loaded && !force) return true;
      if (DB.loading) return false;
      DB.loading = true;
      DB.loadError = "";

      try{
        const [stuTxt, sesTxt] = await Promise.all([
          fetchTextOrThrow(DATA_URLS.students, "site_students.csv"),
          fetchTextOrThrow(DATA_URLS.sessions, "site_sessions.csv"),
        ]);

        const stuRows = parseCSV(stuTxt);
        const sesRows = parseCSV(sesTxt);

        if (stuRows.length < 2) throw new Error("site_students.csv: мало строк (нет данных)");
        if (sesRows.length < 2) throw new Error("site_sessions.csv: мало строк (нет данных)");

        const stuHeader = stuRows.shift().map(normalizeHeader);
        const sesHeader = sesRows.shift().map(normalizeHeader);

        const s_id = findHeader(stuHeader, ["id"]);
        const s_ns = findHeader(stuHeader, ["name_short","кратко"]);
        const s_gr = findHeader(stuHeader, ["group","группа"]);
        const s_st = findHeader(stuHeader, ["status","статус","статус обучения"]);
        if (s_id < 0) throw new Error("students: нет колонки id");

        DB.studentsById.clear();
        for (const r of stuRows){
          const id = normalizeId(r[s_id]);
          if (!id) continue;
          DB.studentsById.set(id, {
            id,
            name_short: (s_ns >= 0 ? (r[s_ns] ?? "") : ""),
            group: (s_gr >= 0 ? (r[s_gr] ?? "") : ""),
            status: (s_st >= 0 ? (r[s_st] ?? "") : ""),
          });
        }

        const c_id = findHeader(sesHeader, ["id"]);
        const c_t = findHeader(sesHeader, ["tournament","турнир"]);
        const c_stage = findHeader(sesHeader, ["stage","этап","стадия"]);
        const c_sno = findHeader(sesHeader, ["session_no","session","сессия"]);
        const c_gno = findHeader(sesHeader, ["game_no","game","игра"]);
        const c_date = findHeader(sesHeader, ["date","дата"]);
        const c_score = findHeader(sesHeader, ["score_or_attendance","score","очки","посещаемость","значение"]);
        const c_place = findHeader(sesHeader, ["place_or_result","place","место","результат"]);
        const c_comment = findHeader(sesHeader, ["comment","комментарий"]);
        const c_extra = findHeader(sesHeader, ["extra","доп"]);
        const c_label = findHeader(sesHeader, ["label","заголовок"]);

        if (c_id < 0) throw new Error("sessions: нет колонки id");
        if (c_t < 0) throw new Error("sessions: нет колонки tournament/турнир");
        if (c_stage < 0) throw new Error("sessions: нет колонки stage/этап");
        if (c_date < 0) throw new Error("sessions: нет колонки date/дата");

        DB.sessionsById.clear();

        for (const r of sesRows){
          const id = normalizeId(r[c_id]);
          if (!id) continue;

          const rowObj = {
            id,
            tournament: (c_t >= 0 ? (r[c_t] ?? "") : ""),
            stage: (c_stage >= 0 ? (r[c_stage] ?? "") : ""),
            session_no: (c_sno >= 0 ? (r[c_sno] ?? "") : ""),
            game_no: (c_gno >= 0 ? (r[c_gno] ?? "") : ""),
            date: (c_date >= 0 ? String(r[c_date] ?? "").trim() : ""),
            score_or_attendance: (c_score >= 0 ? String(r[c_score] ?? "").trim() : ""),
            place_or_result: (c_place >= 0 ? String(r[c_place] ?? "").trim() : ""),
            comment: (c_comment >= 0 ? String(r[c_comment] ?? "").trim() : ""),
            extra: (c_extra >= 0 ? String(r[c_extra] ?? "").trim() : ""),
            label: (c_label >= 0 ? String(r[c_label] ?? "").trim() : ""),
          };

          if (!DB.sessionsById.has(id)) DB.sessionsById.set(id, []);
          DB.sessionsById.get(id).push(rowObj);
        }

        for (const [id, arr] of DB.sessionsById){
          arr.sort((a,b)=> (a.date || "").localeCompare(b.date || ""));
        }

        DB.loaded = true;
        recomputeLeagues();
        return true;
      }catch(e){
        DB.loaded = false;
        DB.loadError = String(e?.message || e);
        return false;
      }finally{
        DB.loading = false;
      }
    }

    // ---------------------------
    // Router
    // ---------------------------
    function setActivePills(){
      const hash = (location.hash || "#/").split("?")[0];
      document.querySelectorAll("[data-link]").forEach(a=>{
        a.classList.toggle("active", a.getAttribute("href") === hash);
      });
    }

    function parseHash(){
      const raw = (location.hash || "#/").replace("#", "");
      const [path, qs] = raw.split("?");
      const parts = path.split("/").filter(Boolean);
      const params = new URLSearchParams(qs || "");
      return { parts, params };
    }

    async function route(){
      setActivePills();
      const {parts, params} = parseHash();

      if (parts.length === 0){
        renderHome();
        return;
      }

      const [page] = parts;

      if (page === "rating"){
        renderRatingSkeleton();
        await ensureDBLoaded(false);
        renderRating(params);
        return;
      }

      if (page === "about" || page === "tournaments" || page === "kb"){
        renderWIP(page);
        return;
      }

      renderNotFound();
    }

    window.addEventListener("hashchange", ()=>{ route(); });

    // ---------------------------
    // Pages
    // ---------------------------
    function renderHome(){
      app.innerHTML = html`
        <div class="card" style="padding:18px">
          <div class="crumbs">КЛТ</div>
          <h2 class="pageTitle">Рейтинг и посещаемость</h2>
          <div class="muted" style="font-weight:800; line-height:1.7">
            Фокусируемся на дашборде рейтинга. Остальные разделы временно в разработке.
          </div>
          <div class="divider"></div>
          <div class="formRow">
            <a class="btn" href="#/rating">Перейти к рейтингу</a>
            <a class="btn secondary" href="https://disk.yandex.ru/d/p1wxZn33wEVVyw" target="_blank" rel="noreferrer">Распределение</a>
          </div>
        </div>
      `;
    }

    function renderWIP(page){
      const title =
        page === "about" ? "О КЛТ" :
        page === "tournaments" ? "Турниры" :
        "База знаний";

      app.innerHTML = html`
        <div class="crumbs">КЛТ / ${esc(title)}</div>
        <h2 class="pageTitle">${esc(title)}</h2>

        <div class="card wip">
          <div class="icon">🔧</div>
          <div class="title">В разработке</div>
          <div class="desc">Сейчас концентрируемся на вкладке «Рейтинг».</div>
          <div style="margin-top:16px">
            <a class="btn" href="#/rating">Открыть рейтинг</a>
          </div>
        </div>
      `;
    }

    function renderRatingSkeleton(){
      app.innerHTML = html`
        <div class="crumbs">КЛТ / Рейтинг</div>
        <h2 class="pageTitle">Рейтинг и посещаемость</h2>
        <div class="card" style="padding:18px">
          <div class="notice">Загружаю данные CSV…</div>
        </div>
      `;
    }

    function renderNotFound(){
      app.innerHTML = html`
        <div class="card" style="padding:18px">
          <h2 class="pageTitle">Страница не найдена</h2>
          <p class="muted">Проверьте ссылку или вернитесь на главную.</p>
          <div style="margin-top:14px">
            <a class="btn" href="#/rating">Открыть рейтинг</a>
          </div>
        </div>
      `;
    }

    function leagueText(league){
      const ui = leagueBadge(league);
      return `
        <span class="badge ${esc(ui.cls)}">${esc(ui.label)}</span>
        <div class="small" style="margin-top:16px">Оценка САОК КЛТ</div>
      `;
    }

    // ✅ UPDATED: rank among обучающихся only
    function getRankPlaceOnly(id){
      const list = Array.from(DB.totalsById.entries()).map(([sid, total])=>({ sid, total }));
      list.sort((a,b)=> b.total - a.total);
      const idx = list.findIndex(x=>x.sid===id);
      if (idx < 0) return "—";
      return String(idx+1);
    }

    // ---------------------------
    // Rating page
    // ---------------------------
    function renderRating(params){
      const presetId = (params.get("id") || "").trim();

      app.innerHTML = html`
        <div class="crumbs">КЛТ / Рейтинг</div>
        <h2 class="pageTitle">Рейтинг и посещаемость</h2>

        <div class="card" style="padding:18px">
          <div class="formRow">
            <input id="studentId" type="text" inputmode="numeric" maxlength="4" placeholder="Введите ID (4 цифры)" />
            <button class="btn" type="button" id="btnShow">Показать</button>
          </div>
          <div class="small" style="margin-top:8px">Если вы не знаете свой ID — обратитесь к сотруднику <b>САОК КЛТ</b>.</div>

          <div id="out" style="margin-top:14px"></div>

          <div class="supportWrap">
            <div class="small">© ${new Date().getFullYear()} · КЛТ.demo</div>
            <div class="supportLink" id="supportLink">Поддержка</div>
          </div>
          <div class="supportBox" id="supportBox">
            Почта: <a href="mailto:SupportKLT@yandex.ru">SupportKLT@yandex.ru</a><br/>
            MAX: <a href="https://clck.ru/3RdkWv" target="_blank" rel="noreferrer">https://clck.ru/3RdkWv</a>
          </div>
        </div>
      `;

      const idInput = document.getElementById("studentId");
      const out = document.getElementById("out");
      const btnShow = document.getElementById("btnShow");

      const supportLink = document.getElementById("supportLink");
      const supportBox = document.getElementById("supportBox");
      supportLink.addEventListener("click", ()=>{
        supportBox.style.display = (supportBox.style.display === "block") ? "none" : "block";
      });

      idInput.addEventListener("input", ()=>{ idInput.value = idInput.value.replace(/\D/g,"").slice(0,4); });

      async function show(){
        const id = normalizeId(idInput.value);

        if (!DB.loaded && !DB.loading){
          out.innerHTML = `<div class="notice">Загружаю данные…</div>`;
          await ensureDBLoaded(false);
        }

        if (!DB.loaded){
          out.innerHTML = `
            <div class="notice bad">
              CSV не загрузились: <b>${esc(DB.loadError || "неизвестная ошибка")}</b><br/>
              Проверь, что сайт открыт через <b>http://localhost:8000</b> и файлы лежат рядом с index.html.
            </div>
          `;
          return;
        }

        if (!id){
          out.innerHTML = `<div class="notice bad">Введите ID (4 цифры).</div>`;
          return;
        }

        const student = DB.studentsById.get(id);
        const sessions = DB.sessionsById.get(id) || [];
        if (!student){
          out.innerHTML = `<div class="notice bad">Студент с ID <b>${esc(id)}</b> не найден.</div>`;
          return;
        }

        const isExpelled = String(student.status || "").trim() === "В списках отчисленных";

        const attSessions = sessions.filter(s=> isAttendanceValue(s.score_or_attendance));
        const presentCount = attSessions.reduce((acc, s)=> acc + (attendanceIsPresent(s.score_or_attendance) === true ? 1 : 0), 0);
        const attTotal = attSessions.length || 0;
        const absences = Math.max(0, attTotal - presentCount);
        const attPercent = attTotal ? Math.round(presentCount / attTotal * 100) : 0;

        const riskByAbsences = absences >= 4 ? {t:"Риск", cls:"b-warn"} : {t:"Норма", cls:"b-ok"};

        const scored = computeScoredSessions(id);
        const totalPoints = scored.reduce((sum,x)=> sum + (x.points || 0), 0);

        // ✅ league/rank now based on обучающихся only
        const league = DB.leagueById.get(id) || "—";
        const rankPlace = getRankPlaceOnly(id);

        const track = calcTrackers(student, sessions, scored);
        const advice = buildAdvice(track);

        const strong = computeStrongSide(scored);
        advice.push({
          title: "Сильная сторона",
          text: strong.text,
          tag: strong.badge.text,
          cls: strong.badge.cls
        });

        out.innerHTML = html`
          <div class="notice ${isExpelled ? "expelled" : "ok"}">
            <b>${esc(student.name_short || "Студент")}</b> ·
            ID: <b>${esc(student.id)}</b> ·
            Группа: <b>${esc(student.group || "—")}</b>
            ${student.status ? ` · Статус: <b>${esc(student.status)}</b>` : ""}
          </div>

          <div class="notice" style="margin-top:10px">
            Баллы и дашборд ведутся <b>исключительно для информационных целей</b> и <b>не влияют</b> на выплаты/начисления.
          </div>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="k">Лига</div>
              <div class="v">${league !== "—" ? leagueText(league) : `<span class="badge b-warn">—</span><div class="small" style="margin-top:16px">Оценка САОК КЛТ</div>`}</div>
            </div>
            <div class="kpi">
              <div class="k">Баллы (сумма)</div>
              <div class="v">${esc(totalPoints)}</div>
              <div class="c">за зачётные сессии (только если посещаемость = 0)</div>
            </div>
            <div class="kpi">
              <div class="k">Посещаемость</div>
              <div class="v">${esc(attPercent)}%</div>
              <div class="c"><span class="badge ${esc(riskByAbsences.cls)}">${esc(riskByAbsences.t)}</span> · прогулов: ${esc(absences)}</div>
            </div>
            <div class="kpi">
              <div class="k">Позиция в общем зачёте</div>
              <div class="v">${esc(rankPlace)}</div>
              <div class="c">место по сумме баллов (среди обучающихся)</div>
            </div>
          </div>

          <div class="dash">
            <div class="chartCard">
              <p class="chartTitle">Прогресс по этапам</p>
              <canvas id="progressChart" width="900" height="320"></canvas>
              <div class="small">Точки = зачётные сессии (наведи — увидишь игру/этап/результат).</div>
            </div>
            <div class="chartCard">
              <p class="chartTitle">Посещаемость</p>
              <canvas id="attChart" width="600" height="320"></canvas>
              <div class="small">Присутствовал: ${esc(presentCount)} из ${esc(attTotal)} · прогулов: ${esc(absences)}</div>
            </div>
          </div>

          <div class="chartRow">
            <div class="chartCard" style="grid-column:1; grid-row:1;">
              <p class="chartTitle">Активность по времени (баллы по датам)</p>
              <canvas id="activityChart" width="900" height="320"></canvas>
              <div class="small">Сумма баллов за день (последние 28 дат с баллами).</div>
            </div>

            <div class="chartCard" style="grid-column:1; grid-row:2;">
              <p class="chartTitle">Топ-3 сильных результата</p>
              <canvas id="top3Chart" width="900" height="240"></canvas>
            </div>

            <div class="chartCard" style="grid-column:2; grid-row:1 / span 2;">
              <p class="chartTitle">Рекомендации по улучшению результата</p>
              <div style="display:grid; gap:10px">
                ${advice.map(a=>html`
                  <div style="padding:12px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.02)">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
                      <div style="font-weight:1100">${esc(a.title)}</div>
                      <span class="badge ${esc(a.cls)}">${esc(a.tag)}</span>
                    </div>
                    <div class="muted" style="margin-top:6px; font-weight:800; line-height:1.6">
                      ${esc(a.text)}
                    </div>
                  </div>
                `).join("")}
              </div>
            </div>
          </div>

          <div class="chartCard" style="margin-top:12px">
            <p class="chartTitle">Начисление баллов</p>
            <table class="table">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Этап</th>
                  <th>Сессия</th>
                  <th>Результат/место</th>
                  <th>Баллы</th>
                  <th>Как посчитали</th>
                </tr>
              </thead>
              <tbody>
                ${
                  scored.length
                    ? scored.map(s=>html`
                      <tr>
                        <td>${esc(formatDateRU(s.date || "—"))}</td>
                        <td><b>${esc(s.tournamentKey)}</b></td>
                        <td class="muted">${esc(s.stage || s.label || "—")}</td>
                        <td class="muted">${esc(s.place_or_result || s.score_or_attendance || "—")}</td>
                        <td><b>${esc(s.points)}</b></td>
                        <td class="muted">${esc(s.explain)}</td>
                      </tr>
                    `).join("")
                    : `<tr><td colspan="6" class="muted">Нет зачётных сессий (баллы считаются только если посещаемость = 0).</td></tr>`
                }
              </tbody>
            </table>
          </div>

          <div class="chartCard" style="margin-top:12px">
            <p class="chartTitle">Все сессии студента</p>
            <table class="table">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Турнир</th>
                  <th>Этап</th>
                  <th>Сессия</th>
                  <th>Игра</th>
                  <th>Очки/Посещаемость</th>
                  <th>Место/Результат</th>
                  <th>Комментарий</th>
                </tr>
              </thead>
              <tbody>
                ${
                  sessions.length
                    ? sessions.map(s=>html`
                      <tr>
                        <td>${esc(formatDateRU(s.date || "—"))}</td>
                        <td><b>${esc(normTournamentKey(s.tournament))}</b></td>
                        <td class="muted">${esc(s.stage || s.label || "—")}</td>
                        <td class="muted">${esc(s.session_no || "—")}</td>
                        <td class="muted">${esc(s.game_no || "—")}</td>
                        <td class="muted">${esc(s.score_or_attendance || "—")}</td>
                        <td class="muted">${esc(s.place_or_result || "—")}</td>
                        <td class="muted">${esc(s.comment || s.extra || "")}</td>
                      </tr>
                    `).join("")
                    : `<tr><td colspan="8" class="muted">Нет записей.</td></tr>`
                }
              </tbody>
            </table>
          </div>
        `;

        drawProgressDots("progressChart", scored);
        attachDotTooltip("progressChart");

        drawDonut("attChart", presentCount, Math.max(0, attTotal - presentCount));

        drawActivityByDate("activityChart", scored);
        attachBarTooltip("activityChart");

        drawTop3("top3Chart", scored);
        attachBarTooltip("top3Chart");
      }

      btnShow.addEventListener("click", show);
      idInput.addEventListener("keydown", (e)=>{ if (e.key==="Enter") show(); });

      if (presetId) idInput.value = presetId.replace(/\D/g,"").slice(0,4);
      show();
    }

    // ---------------------------
    // Boot
    // ---------------------------
    window.addEventListener("load", async ()=>{
      if (!location.hash) location.hash = "#/rating";
      await route();
    });
  </script>
</body>
</html>
